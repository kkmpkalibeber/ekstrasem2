<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manajemen Ekstrakurikuler</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    * {
      box-sizing: border-box;
    }
    .stat-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .menu-item {
      transition: all 0.2s;
    }
    .menu-item:hover {
      background: rgba(34, 197, 94, 0.1);
      transform: translateX(4px);
    }
    .menu-item.active {
      background: linear-gradient(90deg, #22c55e 0%, #10b981 100%);
      color: white;
      font-weight: 600;
    }
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      transition: all 0.2s;
    }
    .btn-primary:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    .progress-bar {
      transition: width 0.3s ease;
    }
    .datalist-input {
      position: relative;
    }
    .datalist-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    .datalist-dropdown.show {
      display: block;
    }
    .datalist-option {
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .datalist-option:hover {
      background: #f3f4f6;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .preview-table {
      max-height: 400px;
      overflow-y: auto;
      overflow-x: auto;
    }
    .file-upload-area {
      border: 2px dashed #d1d5db;
      transition: all 0.2s;
    }
    .file-upload-area:hover {
      border-color: #3b82f6;
      background: #f9fafb;
    }
    .file-upload-area.dragover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    /* Export Notification */
    .export-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .export-notification.error {
      background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
      box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
    }
    .export-notification.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
      box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50">
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay hidden">
   <div class="text-center">
    <div class="spinner mx-auto mb-4"></div>
    <p class="text-gray-700 font-medium">Memuat data dari Google Sheets...</p>
   </div>
  </div>
  
  <div class="w-full h-full flex">
   <!-- Sidebar -->
   <aside id="sidebar" class="w-64 bg-white shadow-lg flex flex-col" style="height: 100%;">
    <div class="p-6 border-b border-gray-200">
     <h1 id="appTitle" class="text-2xl font-bold text-gray-800">Manajemen Ekskul</h1>
     <p id="schoolName" class="text-sm text-gray-500 mt-1">SMA  TAKHASSUS AL QURAN WONOSOBO</p>
    </div>
    <nav class="flex-1 p-4 overflow-y-auto">
     <a href="#" class="menu-item active flex items-center px-4 py-3 rounded-lg mb-2" data-page="dashboard">
      <span class="mr-3">üìä</span>
      <span>Dashboard</span>
     </a>
     <a href="#" class="menu-item flex items-center px-4 py-3 rounded-lg mb-2" data-page="anggota">
      <span class="mr-3">üë•</span>
      <span>Data Anggota</span>
     </a>
     <a href="#" class="menu-item flex items-center px-4 py-3 rounded-lg mb-2" data-page="ekstra">
      <span class="mr-3">üéØ</span>
      <span>Jenis Ekstra</span>
     </a>
     <a href="#" class="menu-item flex items-center px-4 py-3 rounded-lg mb-2" data-page="penilaian">
      <span class="mr-3">‚≠ê</span>
      <span>Penilaian</span>
     </a>
     <a href="#" class="menu-item flex items-center px-4 py-3 rounded-lg mb-2" data-page="absensi">
      <span class="mr-3">üìù</span>
      <span>Absensi</span>
     </a>
     <a href="#" class="menu-item flex items-center px-4 py-3 rounded-lg mb-2" data-page="jurnal">
      <span class="mr-3">üìî</span>
      <span>Jurnal Kegiatan</span>
     </a>
     <a href="#" class="menu-item flex items-center px-4 py-3 rounded-lg mb-2" data-page="laporan">
      <span class="mr-3">üìÑ</span>
      <span>Laporan</span>
     </a>
    </nav>
    <div class="p-4 border-t border-gray-200">
     <div class="flex items-center justify-center gap-2 text-xs text-gray-500">
      <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
      <span>Terhubung ke Google Sheets</span>
     </div>
    </div>
   </aside>
   
   <!-- Main Content -->
   <main class="flex-1 overflow-y-auto" style="height: 100%;">
    <div class="p-8">
     <!-- Dashboard Page -->
     <div id="page-dashboard" class="page-content fade-in">
      <div class="mb-8">
       <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
       <p class="text-gray-600 mt-1">Ringkasan data ekstrakurikuler</p>
      </div>
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
       <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm">Total Anggota</p>
          <p id="stat-anggota" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="w-14 h-14 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white text-2xl">üë•</div>
        </div>
       </div>
       <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm">Jenis Ekstra</p>
          <p id="stat-ekstra" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="w-14 h-14 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center text-white text-2xl">üéØ</div>
        </div>
       </div>
       <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm">Total Penilaian</p>
          <p id="stat-penilaian" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="w-14 h-14 bg-gradient-to-br from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white text-2xl">‚≠ê</div>
        </div>
       </div>
       <div class="stat-card bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm">Jurnal Kegiatan</p>
          <p id="stat-jurnal" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="w-14 h-14 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full flex items-center justify-center text-white text-2xl">üìî</div>
        </div>
       </div>
      </div>
      
      <!-- Activity & Distribution -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
       <!-- Recent Activity -->
       <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Aktivitas Terbaru</h3>
        <div id="recent-activity" class="space-y-3">
         <p class="text-gray-500 text-sm">Belum ada aktivitas</p>
        </div>
       </div>
       <!-- Distribution -->
       <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Distribusi Ekstrakurikuler</h3>
        <div id="distribution-chart" class="space-y-3">
         <p class="text-gray-500 text-sm">Belum ada data</p>
        </div>
       </div>
      </div>
     </div>
     
     <!-- Anggota Page -->
     <div id="page-anggota" class="page-content hidden">
      <div class="flex justify-between items-center mb-6">
       <div>
        <h2 class="text-3xl font-bold text-gray-800">Data Anggota</h2>
        <p class="text-gray-600 mt-1">Kelola data anggota ekstrakurikuler</p>
       </div>
       <div class="flex gap-3">
        <button onclick="downloadTemplateAnggota()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700">üì• Download Template</button>
        <button onclick="openImportAnggotaModal()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-purple-700">üì§ Import CSV</button>
        <button onclick="openAddAnggotaModal()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">+ Tambah Anggota</button>
       </div>
      </div>
      
      <!-- Search Filter -->
      <div class="bg-white rounded-xl shadow-md p-4 mb-4">
       <div class="flex items-center gap-3">
        <div class="flex-1">
         <input type="text" id="search-anggota" placeholder="üîç Cari berdasarkan nama atau ekstrakurikuler..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <button onclick="clearSearchAnggota()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">‚úï Clear</button>
       </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
       <div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
        <table class="w-full">
         <thead class="bg-gradient-to-r from-green-50 to-blue-50 sticky top-0">
          <tr>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Nama</th>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Kelas</th>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Ekstrakurikuler</th>
           <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">Aksi</th>
          </tr>
         </thead>
         <tbody id="anggota-table" class="divide-y divide-gray-200">
          <tr>
           <td colspan="4" class="px-6 py-8 text-center text-gray-500">Belum ada data anggota</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div>
     
     <!-- Ekstra Page -->
     <div id="page-ekstra" class="page-content hidden">
      <div class="flex justify-between items-center mb-6">
       <div>
        <h2 class="text-3xl font-bold text-gray-800">Jenis Ekstrakurikuler</h2>
        <p class="text-gray-600 mt-1">Kelola jenis ekstrakurikuler</p>
       </div>
       <div class="flex gap-3">
        <button onclick="downloadTemplateEkstra()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700">üì• Download Template</button>
        <button onclick="openImportEkstraModal()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-purple-700">üì§ Import CSV</button>
        <button onclick="openAddEkstraModal()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">+ Tambah Ekstra</button>
       </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
       <div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
        <table class="w-full">
         <thead class="bg-gradient-to-r from-green-50 to-blue-50 sticky top-0">
          <tr>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Nama Ekstrakurikuler</th>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Pembina</th>
           <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">Aksi</th>
          </tr>
         </thead>
         <tbody id="ekstra-table" class="divide-y divide-gray-200">
          <tr>
           <td colspan="3" class="px-6 py-8 text-center text-gray-500">Belum ada data ekstrakurikuler</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div>
     
     <!-- Penilaian Page -->
     <div id="page-penilaian" class="page-content hidden">
      <div class="mb-6">
       <h2 class="text-3xl font-bold text-gray-800">Penilaian</h2>
       <p class="text-gray-600 mt-1">Input penilaian klasikal per ekstrakurikuler</p>
      </div>
      
      <!-- Form Input Klasikal -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
       <h3 class="text-xl font-bold text-gray-800 mb-4">üìù Input Penilaian Klasikal</h3>
       <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Ekstrakurikuler</label>
        <select id="penilaian-select-ekstra" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
         <option value="">-- Pilih Ekstrakurikuler --</option>
        </select>
       </div>
       <div id="penilaian-klasikal-container" class="hidden">
        <form id="form-penilaian-klasikal">
         <div class="mb-4 overflow-x-auto">
          <table class="w-full">
           <thead class="bg-gray-100">
            <tr>
             <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama</th>
             <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kelas</th>
             <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nilai</th>
             <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Catatan</th>
            </tr>
           </thead>
           <tbody id="penilaian-klasikal-tbody"></tbody>
          </table>
         </div>
         <button type="submit" id="btn-save-penilaian-klasikal" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">Simpan Semua Penilaian</button>
        </form>
       </div>
       <div id="penilaian-no-ekstra" class="text-center py-8 text-gray-500">
        Pilih ekstrakurikuler untuk mulai input penilaian
       </div>
      </div>
      
      <!-- Tabel Kelola Data -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
       <div class="p-6 border-b border-gray-200">
        <h3 class="text-xl font-bold text-gray-800">üìã Kelola Data Penilaian</h3>
       </div>
       <div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
        <table class="w-full">
         <thead class="bg-gradient-to-r from-green-50 to-blue-50 sticky top-0">
          <tr>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Nama</th>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Kelas</th>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Ekstra</th>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Nilai</th>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Catatan</th>
           <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">Aksi</th>
          </tr>
         </thead>
         <tbody id="penilaian-table" class="divide-y divide-gray-200">
          <tr>
           <td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada data penilaian</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div>
     
     <!-- Absensi Page -->
     <div id="page-absensi" class="page-content hidden">
      <div class="mb-6">
       <h2 class="text-3xl font-bold text-gray-800">Absensi</h2>
       <p class="text-gray-600 mt-1">Input absensi klasikal per ekstrakurikuler</p>
      </div>
      
      <!-- Form Input Klasikal -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
       <h3 class="text-xl font-bold text-gray-800 mb-4">‚úÖ Input Absensi Klasikal</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
         <input type="date" id="absensi-tanggal-klasikal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Ekstrakurikuler</label>
         <select id="absensi-select-ekstra" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="">-- Pilih Ekstrakurikuler --</option>
         </select>
        </div>
       </div>
       <div id="absensi-klasikal-container" class="hidden">
        <form id="form-absensi-klasikal">
         <div class="mb-4 overflow-x-auto">
          <table class="w-full">
           <thead class="bg-gray-100">
            <tr>
             <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama</th>
             <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kelas</th>
             <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Status</th>
            </tr>
           </thead>
           <tbody id="absensi-klasikal-tbody"></tbody>
          </table>
         </div>
         <button type="submit" id="btn-save-absensi-klasikal" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">üíæ Simpan Semua Absensi</button>
        </form>
       </div>
       <div id="absensi-no-ekstra" class="text-center py-8 text-gray-500">
        Pilih tanggal dan ekstrakurikuler untuk mulai input absensi
       </div>
      </div>
      
      <!-- Tabel Kelola Data -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
       <div class="p-6 border-b border-gray-200">
        <h3 class="text-xl font-bold text-gray-800">üìã Kelola Data Absensi</h3>
       </div>
       <div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
        <table class="w-full">
         <thead class="bg-gradient-to-r from-green-50 to-blue-50 sticky top-0">
          <tr>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Tanggal</th>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Nama</th>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Kelas</th>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Ekstra</th>
           <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">Status</th>
           <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">Aksi</th>
          </tr>
         </thead>
         <tbody id="absensi-table" class="divide-y divide-gray-200">
          <tr>
           <td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada data absensi</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div>
     
     <!-- Jurnal Page -->
     <div id="page-jurnal" class="page-content hidden">
      <div class="flex justify-between items-center mb-6">
       <div>
        <h2 class="text-3xl font-bold text-gray-800">Jurnal Kegiatan</h2>
        <p class="text-gray-600 mt-1">Kelola jurnal kegiatan ekstrakurikuler</p>
       </div>
       <button onclick="openAddJurnalModal()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">+ Tambah Jurnal</button>
      </div>
      <div class="space-y-4" id="jurnal-list">
       <p class="text-gray-500 text-center py-8">Belum ada jurnal kegiatan</p>
      </div>
     </div>
     
     <!-- Laporan Page -->
     <div id="page-laporan" class="page-content hidden">
      <div class="mb-6">
       <h2 class="text-3xl font-bold text-gray-800">Laporan</h2>
       <p class="text-gray-600 mt-1">Ringkasan dan statistik lengkap</p>
      </div>
      
      <!-- Laporan Kehadiran -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">Laporan Kehadiran</h3>
        <button onclick="exportKehadiran()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 flex items-center gap-2">
         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
         </svg>
         üì• Export Excel
        </button>
       </div>
       
       <!-- Filter Kehadiran -->
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">Nama</label>
         <input type="text" id="filter-kehadiran-nama" placeholder="Cari nama..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
         <input type="text" id="filter-kehadiran-kelas" placeholder="Cari kelas..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">Ekstrakurikuler</label>
         <select id="filter-kehadiran-ekstra" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="">Semua Ekstra</option>
         </select>
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
         <select id="filter-kehadiran-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="">Semua Status</option>
          <option value="H">Hadir (H)</option>
          <option value="S">Sakit (S)</option>
          <option value="I">Izin (I)</option>
          <option value="A">Alpa (A)</option>
         </select>
        </div>
       </div>
       
       <!-- Rentang Tanggal -->
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
         <input type="date" id="filter-kehadiran-dari" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
         <input type="date" id="filter-kehadiran-sampai" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="flex items-end">
         <button onclick="applyFilterKehadiran()" class="w-full btn-primary text-white px-4 py-2 rounded-lg font-medium">Terapkan Filter</button>
        </div>
       </div>
       
       <!-- Tabel Hasil -->
       <div class="overflow-x-auto">
        <table class="w-full" id="table-kehadiran">
         <thead class="bg-gray-50">
          <tr>
           <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
           <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tanggal</th>
           <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama</th>
           <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kelas</th>
           <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Ekstra</th>
           <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Status</th>
          </tr>
         </thead>
         <tbody id="tbody-kehadiran" class="divide-y divide-gray-200">
          <tr>
           <td colspan="6" class="px-4 py-6 text-center text-gray-500">Belum ada data</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
      
      <!-- Laporan Jurnal -->
      <div class="bg-white rounded-xl shadow-md p-6">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">Laporan Jurnal</h3>
        <button onclick="exportJurnal()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 flex items-center gap-2">
         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
         </svg>
         üì• Export Excel
        </button>
       </div>
       
       <!-- Filter Jurnal -->
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">Ekstrakurikuler</label>
         <select id="filter-jurnal-ekstra" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="">Semua Ekstra</option>
         </select>
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
         <input type="date" id="filter-jurnal-dari" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
         <input type="date" id="filter-jurnal-sampai" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
       </div>
       
       <div class="mb-6">
        <button onclick="applyFilterJurnal()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">Terapkan Filter</button>
       </div>
       
       <!-- Tabel Hasil Jurnal -->
       <div class="overflow-x-auto">
        <table class="w-full" id="table-jurnal">
         <thead class="bg-gray-50">
          <tr>
           <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
           <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tanggal</th>
           <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Ekstra</th>
           <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kegiatan</th>
           <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Deskripsi</th>
          </tr>
         </thead>
         <tbody id="tbody-jurnal" class="divide-y divide-gray-200">
          <tr>
           <td colspan="5" class="px-4 py-6 text-center text-gray-500">Belum ada data</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div>
  
  <!-- Modal Anggota -->
  <div id="modal-anggota" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-xl shadow-2xl w-full max-w-md fade-in">
    <div class="p-6 border-b border-gray-200">
     <h3 id="modal-anggota-title" class="text-2xl font-bold text-gray-800">Tambah Anggota</h3>
    </div>
    <form id="form-anggota" class="p-6 space-y-4">
     <input type="hidden" id="anggota-id">
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Nama</label>
      <input type="text" id="anggota-nama" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan nama">
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
      <div class="datalist-input">
       <input type="text" id="anggota-kelas" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ketik atau pilih kelas" autocomplete="off">
       <div id="kelas-dropdown" class="datalist-dropdown"></div>
      </div>
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Ekstrakurikuler</label>
      <select id="anggota-ekstra" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       <option value="">Pilih ekstrakurikuler</option>
      </select>
     </div>
     <div class="flex gap-3 pt-4">
      <button type="button" onclick="closeModal('modal-anggota')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50">Batal</button>
      <button type="submit" id="btn-save-anggota" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg font-medium">Simpan</button>
     </div>
    </form>
   </div>
  </div>
  
  <!-- Modal Ekstra -->
  <div id="modal-ekstra" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-xl shadow-2xl w-full max-w-md fade-in">
    <div class="p-6 border-b border-gray-200">
     <h3 id="modal-ekstra-title" class="text-2xl font-bold text-gray-800">Tambah Ekstrakurikuler</h3>
    </div>
    <form id="form-ekstra" class="p-6 space-y-4">
     <input type="hidden" id="ekstra-id">
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Nama Ekstrakurikuler</label>
      <input type="text" id="ekstra-nama" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contoh: Basket">
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Pembina</label>
      <input type="text" id="ekstra-pembina" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nama pembina">
     </div>
     <div class="flex gap-3 pt-4">
      <button type="button" onclick="closeModal('modal-ekstra')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50">Batal</button>
      <button type="submit" id="btn-save-ekstra" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg font-medium">Simpan</button>
     </div>
    </form>
   </div>
  </div>
  
  <!-- Modal Import Ekstra -->
  <div id="modal-import-ekstra" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl fade-in" style="max-height: 90%; display: flex; flex-direction: column;">
    <div class="p-6 border-b border-gray-200">
     <h3 class="text-2xl font-bold text-gray-800">üì§ Import Data Ekstrakurikuler</h3>
     <p class="text-sm text-gray-600 mt-1">Upload file CSV dengan format: nama,pembina</p>
    </div>
    <div class="p-6 overflow-y-auto flex-1">
     <!-- Upload Area -->
     <div class="mb-6">
      <label class="file-upload-area block w-full p-8 text-center rounded-lg cursor-pointer">
       <input type="file" id="file-ekstra" accept=".csv" class="hidden" onchange="handleFileEkstra(event)">
       <div class="text-4xl mb-3">üìÅ</div>
       <p class="text-gray-700 font-medium">Klik atau drag file CSV ke sini</p>
       <p class="text-sm text-gray-500 mt-1">Format: nama,pembina</p>
      </label>
     </div>
     
     <!-- Preview Area -->
     <div id="preview-ekstra" class="hidden">
      <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
       <p class="text-sm font-medium text-blue-800">‚úì File berhasil dibaca: <span id="filename-ekstra"></span></p>
       <p class="text-sm text-blue-600 mt-1">Total <span id="count-ekstra"></span> data siap diimport</p>
      </div>
      <div class="preview-table border border-gray-300 rounded-lg mb-4">
       <table class="w-full">
        <thead class="bg-gray-100">
         <tr>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama Ekstrakurikuler</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Pembina</th>
         </tr>
        </thead>
        <tbody id="tbody-preview-ekstra"></tbody>
       </table>
      </div>
      <div class="flex gap-3">
       <button type="button" onclick="closeModal('modal-import-ekstra')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50">Batal</button>
       <button type="button" onclick="importEkstraData()" id="btn-import-ekstra" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-700">Import Semua Data</button>
      </div>
     </div>
     <div id="no-preview-ekstra" class="text-center text-gray-500 py-8">Belum ada file yang dipilih</div>
    </div>
   </div>
  </div>
  
  <!-- Modal Import Anggota -->
  <div id="modal-import-anggota" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl fade-in" style="max-height: 90%; display: flex; flex-direction: column;">
    <div class="p-6 border-b border-gray-200">
     <h3 class="text-2xl font-bold text-gray-800">üì§ Import Data Anggota</h3>
     <p class="text-sm text-gray-600 mt-1">Upload file CSV dengan format: nama,kelas,ekstra</p>
    </div>
    <div class="p-6 overflow-y-auto flex-1">
     <!-- Upload Area -->
     <div class="mb-6">
      <label class="file-upload-area block w-full p-8 text-center rounded-lg cursor-pointer">
       <input type="file" id="file-anggota" accept=".csv" class="hidden" onchange="handleFileAnggota(event)">
       <div class="text-4xl mb-3">üìÅ</div>
       <p class="text-gray-700 font-medium">Klik atau drag file CSV ke sini</p>
       <p class="text-sm text-gray-500 mt-1">Format: nama,kelas,ekstra</p>
      </label>
     </div>
     
     <!-- Preview Area -->
     <div id="preview-anggota" class="hidden">
      <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
       <p class="text-sm font-medium text-blue-800">‚úì File berhasil dibaca: <span id="filename-anggota"></span></p>
       <p class="text-sm text-blue-600 mt-1">Total <span id="count-anggota"></span> data siap diimport</p>
      </div>
      <div id="warning-anggota" class="hidden mb-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
       <p class="text-sm font-medium text-yellow-800">‚ö†Ô∏è Peringatan:</p>
       <p class="text-sm text-yellow-700 mt-1" id="warning-text-anggota"></p>
      </div>
      <div class="preview-table border border-gray-300 rounded-lg mb-4">
       <table class="w-full">
        <thead class="bg-gray-100">
         <tr>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kelas</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Ekstrakurikuler</th>
         </tr>
        </thead>
        <tbody id="tbody-preview-anggota"></tbody>
       </table>
      </div>
      <div class="flex gap-3">
       <button type="button" onclick="closeModal('modal-import-anggota')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50">Batal</button>
       <button type="button" onclick="importAnggotaData()" id="btn-import-anggota" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-700">Import Semua Data</button>
      </div>
     </div>
     <div id="no-preview-anggota" class="text-center text-gray-500 py-8">Belum ada file yang dipilih</div>
    </div>
   </div>
  </div>
  
  <!-- Modal Penilaian -->
  <div id="modal-penilaian" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-xl shadow-2xl w-full max-w-md fade-in">
    <div class="p-6 border-b border-gray-200">
     <h3 id="modal-penilaian-title" class="text-2xl font-bold text-gray-800">Tambah Penilaian</h3>
    </div>
    <form id="form-penilaian" class="p-6 space-y-4">
     <input type="hidden" id="penilaian-id">
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Ekstrakurikuler</label>
      <select id="penilaian-ekstra" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       <option value="">Pilih ekstrakurikuler</option>
      </select>
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label>
      <select id="penilaian-nama" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       <option value="">Pilih siswa</option>
      </select>
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Nilai</label>
      <select id="penilaian-nilai" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       <option value="Sangat Baik">Sangat Baik</option>
       <option value="Baik" selected>Baik</option>
       <option value="Sedang">Sedang</option>
       <option value="Cukup">Cukup</option>
      </select>
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
      <textarea id="penilaian-catatan" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Catatan tambahan (opsional)"></textarea>
     </div>
     <div class="flex gap-3 pt-4">
      <button type="button" onclick="closeModal('modal-penilaian')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50">Batal</button>
      <button type="submit" id="btn-save-penilaian" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg font-medium">Simpan</button>
     </div>
    </form>
   </div>
  </div>
  
  <!-- Modal Absensi -->
  <div id="modal-absensi" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-xl shadow-2xl w-full max-w-md fade-in">
    <div class="p-6 border-b border-gray-200">
     <h3 id="modal-absensi-title" class="text-2xl font-bold text-gray-800">Tambah Absensi</h3>
    </div>
    <form id="form-absensi" class="p-6 space-y-4">
     <input type="hidden" id="absensi-id">
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
      <input type="date" id="absensi-tanggal" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Ekstrakurikuler</label>
      <select id="absensi-ekstra" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       <option value="">Pilih ekstrakurikuler</option>
      </select>
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label>
      <select id="absensi-nama" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       <option value="">Pilih siswa</option>
      </select>
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
      <select id="absensi-status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       <option value="H" selected>Hadir (H)</option>
       <option value="S">Sakit (S)</option>
       <option value="I">Izin (I)</option>
       <option value="A">Alpa (A)</option>
      </select>
     </div>
     <div class="flex gap-3 pt-4">
      <button type="button" onclick="closeModal('modal-absensi')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50">Batal</button>
      <button type="submit" id="btn-save-absensi" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg font-medium">Simpan</button>
     </div>
    </form>
   </div>
  </div>
  
  <!-- Modal Jurnal -->
  <div id="modal-jurnal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-xl shadow-2xl w-full max-w-md fade-in">
    <div class="p-6 border-b border-gray-200">
     <h3 id="modal-jurnal-title" class="text-2xl font-bold text-gray-800">Tambah Jurnal</h3>
    </div>
    <form id="form-jurnal" class="p-6 space-y-4">
     <input type="hidden" id="jurnal-id">
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
      <input type="date" id="jurnal-tanggal" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Ekstrakurikuler</label>
      <select id="jurnal-ekstra" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       <option value="">Pilih ekstrakurikuler</option>
      </select>
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Kegiatan</label>
      <input type="text" id="jurnal-kegiatan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Judul kegiatan">
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
      <textarea id="jurnal-deskripsi" rows="3" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Deskripsi kegiatan"></textarea>
     </div>
     <div class="flex gap-3 pt-4">
      <button type="button" onclick="closeModal('modal-jurnal')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50">Batal</button>
      <button type="submit" id="btn-save-jurnal" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg font-medium">Simpan</button>
     </div>
    </form>
   </div>
  </div>
  
  <!-- Export Notification -->
  <div id="export-notification" class="export-notification hidden">
   <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
   </svg>
   <div>
    <p class="font-bold">Export Berhasil!</p>
    <p class="text-sm opacity-90">File CSV telah diunduh dan data siap paste ke Excel</p>
   </div>
  </div>
  
  <script>
    // Google Sheets Web App URL
    const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbw1Io-6odIXve2V3C94iu1g73HA02w4onIVr6T6UzWJEtBWlcxDAlBXUn4f7KVdPRp-/exec';
    
    let allData = [];
    let currentRecordCount = 0;
    let filteredKehadiranData = [];
    let filteredJurnalData = [];
    let isLoading = false;
    let importEkstraQueue = [];
    let importAnggotaQueue = [];

    const defaultConfig = {
      app_title: "Manajemen Ekskul",
      school_name: "SMA TAKHASSUS AL QUR'AN",
      background_color: "#f9fafb",
      surface_color: "#ffffff",
      text_color: "#1f2937",
      primary_action_color: "#3b82f6",
      secondary_action_color: "#22c55e"
    };

    // === GOOGLE SHEETS API FUNCTIONS ===
    
    async function fetchAllData() {
      showLoading(true);
      try {
        const response = await fetch(GOOGLE_SHEETS_URL + '?action=READ_ALL');
        const result = await response.json();
        
        if (result.success) {
          allData = result.data;
          currentRecordCount = allData.length;
          updateUI();
          updateDashboard();
          updateDistribution();
          updateRecentActivity();
          applyFilterKehadiran();
          applyFilterJurnal();
        } else {
          showToast('Gagal memuat data: ' + result.message);
        }
      } catch (error) {
        showToast('Error: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    async function createRecord(type, record) {
      showLoading(true);
      try {
        const params = new URLSearchParams({
          action: 'CREATE',
          type: type,
          data: JSON.stringify(record)
        });
        
        const response = await fetch(GOOGLE_SHEETS_URL + '?' + params.toString());
        const result = await response.json();
        
        if (result.success) {
          await fetchAllData();
          showToast('Data berhasil ditambahkan!');
          return true;
        } else {
          showToast('Gagal menambahkan data: ' + result.message);
          return false;
        }
      } catch (error) {
        showToast('Error: ' + error.message);
        return false;
      } finally {
        showLoading(false);
      }
    }

    async function updateRecord(type, id, record) {
      showLoading(true);
      try {
        const params = new URLSearchParams({
          action: 'UPDATE',
          type: type,
          id: id,
          data: JSON.stringify(record)
        });
        
        const response = await fetch(GOOGLE_SHEETS_URL + '?' + params.toString());
        const result = await response.json();
        
        if (result.success) {
          await fetchAllData();
          showToast('Data berhasil diupdate!');
          return true;
        } else {
          showToast('Gagal mengupdate data: ' + result.message);
          return false;
        }
      } catch (error) {
        showToast('Error: ' + error.message);
        return false;
      } finally {
        showLoading(false);
      }
    }

    async function deleteRecord(type, id) {
      showLoading(true);
      try {
        const params = new URLSearchParams({
          action: 'DELETE',
          type: type,
          id: id
        });
        
        const response = await fetch(GOOGLE_SHEETS_URL + '?' + params.toString());
        const result = await response.json();
        
        if (result.success) {
          await fetchAllData();
          showToast('Data berhasil dihapus!');
          return true;
        } else {
          showToast('Gagal menghapus data: ' + result.message);
          return false;
        }
      } catch (error) {
        showToast('Error: ' + error.message);
        return false;
      } finally {
        showLoading(false);
      }
    }

    // === CASCADE DELETE WITH WARNING ===
    
    async function showConfirmDelete(type, id) {
      showLoading(true);
      
      try {
        const params = new URLSearchParams({
          action: 'CHECK_RELATED',
          type: type,
          id: id
        });
        
        const response = await fetch(GOOGLE_SHEETS_URL + '?' + params.toString());
        const result = await response.json();
        
        showLoading(false);
        
        if (!result.success) {
          showToast('Error: ' + result.message);
          return;
        }
        
        const { count, details, name } = result.data;
        
        let warningMessage = '';
        let detailMessage = '';
        
        if (type === 'anggota' && count > 0) {
          warningMessage = `‚ö†Ô∏è PERINGATAN: Menghapus anggota "${name}" akan menghapus:`;
          detailMessage = `
            <ul class="list-disc list-inside text-sm text-gray-700 mb-4 space-y-1">
              ${details.penilaian > 0 ? `<li>${details.penilaian} data penilaian</li>` : ''}
              ${details.absensi > 0 ? `<li>${details.absensi} data absensi</li>` : ''}
            </ul>
            <p class="text-sm font-semibold text-red-600 mb-2">Total: ${count} data akan terhapus permanen!</p>
          `;
        } else if (type === 'ekstra' && count > 0) {
          warningMessage = `‚ö†Ô∏è PERINGATAN: Menghapus ekstrakurikuler "${name}" akan menghapus:`;
          detailMessage = `
            <ul class="list-disc list-inside text-sm text-gray-700 mb-4 space-y-1">
              ${details.anggota > 0 ? `<li>${details.anggota} data anggota</li>` : ''}
              ${details.penilaian > 0 ? `<li>${details.penilaian} data penilaian</li>` : ''}
              ${details.absensi > 0 ? `<li>${details.absensi} data absensi</li>` : ''}
              ${details.jurnal > 0 ? `<li>${details.jurnal} data jurnal</li>` : ''}
            </ul>
            <p class="text-sm font-semibold text-red-600 mb-2">Total: ${count} data akan terhapus permanen!</p>
          `;
        }
        
        const confirmDiv = document.createElement('div');
        confirmDiv.className = 'fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4';
        confirmDiv.innerHTML = `
          <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md fade-in">
            <h3 class="text-xl font-bold text-red-600 mb-3">üóëÔ∏è Konfirmasi Hapus</h3>
            ${warningMessage ? `<p class="text-sm font-semibold text-gray-800 mb-3">${warningMessage}</p>` : ''}
            ${detailMessage}
            <p class="text-gray-600 mb-6">${warningMessage ? 'Data yang sudah dihapus tidak dapat dikembalikan.' : 'Apakah Anda yakin ingin menghapus data ini?'}</p>
            <div class="flex gap-3">
              <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50">
                Batal
              </button>
              <button onclick="executeDelete('${type}', '${id}')" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700">
                ${count > 0 ? 'Ya, Hapus Semua' : 'Ya, Hapus'}
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(confirmDiv);
      } catch (error) {
        showLoading(false);
        showToast('Error: ' + error.message);
      }
    }

    async function executeDelete(type, id) {
      const modal = document.querySelector('.modal-overlay:last-child');
      if (modal) modal.remove();
      await deleteRecord(type, id);
    }

    function showLoading(show) {
      const overlay = document.getElementById('loading-overlay');
      if (show) {
        overlay.classList.remove('hidden');
      } else {
        overlay.classList.add('hidden');
      }
      isLoading = show;
    }

    // === EXPORT TO EXCEL FUNCTIONS ===
    
    function exportKehadiran() {
      if (filteredKehadiranData.length === 0) {
        showExportNotification('error', 'Tidak ada data untuk di-export', 'Filter data terlebih dahulu');
        return;
      }

      try {
        // Siapkan data untuk export
        const headers = ['No', 'Tanggal', 'Nama', 'Kelas', 'Ekstrakurikuler', 'Status'];
        const rows = filteredKehadiranData.map((item, index) => [
          index + 1,
          item.tanggal,
          item.nama,
          item.kelas,
          item.ekstra,
          getStatusText(item.status)
        ]);
        
        // Download file CSV
        downloadCSV('laporan_kehadiran', headers, rows);
        
        // Juga copy ke clipboard
        copyToClipboardForExcel(headers, rows);
        
        showExportNotification('success', 'Export Berhasil!', 'File telah diunduh dan data siap paste ke Excel');
        
      } catch (error) {
        console.error('Error export:', error);
        showExportNotification('error', 'Export Gagal!', error.message);
      }
    }

    function exportJurnal() {
      if (filteredJurnalData.length === 0) {
        showExportNotification('error', 'Tidak ada data untuk di-export', 'Filter data terlebih dahulu');
        return;
      }

      try {
        const headers = ['No', 'Tanggal', 'Ekstrakurikuler', 'Kegiatan', 'Deskripsi'];
        const rows = filteredJurnalData.map((item, index) => [
          index + 1,
          item.tanggal,
          item.ekstra,
          item.kegiatan,
          item.deskripsi
        ]);
        
        downloadCSV('laporan_jurnal', headers, rows);
        copyToClipboardForExcel(headers, rows);
        
        showExportNotification('success', 'Export Berhasil!', 'File telah diunduh dan data siap paste ke Excel');
        
      } catch (error) {
        console.error('Error export:', error);
        showExportNotification('error', 'Export Gagal!', error.message);
      }
    }

    function getStatusText(statusCode) {
      switch(statusCode) {
        case 'H': return 'Hadir';
        case 'S': return 'Sakit';
        case 'I': return 'Izin';
        case 'A': return 'Alpa';
        default: return statusCode;
      }
    }

    function downloadCSV(filename, headers, rows) {
      // Format CSV dengan UTF-8 BOM untuk Excel
      let csv = '\uFEFF'; // UTF-8 BOM
      csv += headers.join('\t') + '\n';
      
      rows.forEach(row => {
        const formattedRow = row.map(cell => {
          // Escape cell yang mengandung tab, newline, atau kutip
          if (typeof cell === 'string' && (cell.includes('\t') || cell.includes('\n') || cell.includes('"'))) {
            return '"' + cell.replace(/"/g, '""') + '"';
          }
          return cell;
        });
        csv += formattedRow.join('\t') + '\n';
      });
      
      // Buat blob dan download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${filename}_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function copyToClipboardForExcel(headers, rows) {
      try {
        // Format untuk clipboard (tab-separated values)
        let clipboardData = headers.join('\t') + '\n';
        rows.forEach(row => {
          clipboardData += row.join('\t') + '\n';
        });
        
        // Coba copy menggunakan Clipboard API modern
        navigator.clipboard.writeText(clipboardData).then(() => {
          console.log('Data berhasil dicopy ke clipboard');
        }).catch(err => {
          console.log('Clipboard API gagal, menggunakan fallback:', err);
          manualCopyToClipboard(clipboardData);
        });
      } catch (error) {
        console.error('Error copying to clipboard:', error);
      }
    }

    function manualCopyToClipboard(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.left = '-9999px';
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        const successful = document.execCommand('copy');
        console.log(successful ? 'Manual copy berhasil' : 'Manual copy gagal');
      } catch (err) {
        console.error('Manual copy failed:', err);
      } finally {
        document.body.removeChild(textarea);
      }
    }

    function showExportNotification(type, title, message) {
      const notification = document.getElementById('export-notification');
      const icon = notification.querySelector('svg');
      const titleEl = notification.querySelector('p.font-bold');
      const messageEl = notification.querySelector('p.text-sm');
      
      // Update content
      titleEl.textContent = title;
      messageEl.textContent = message;
      
      // Update style berdasarkan type
      notification.className = 'export-notification';
      if (type === 'error') {
        notification.classList.add('error');
      } else if (type === 'warning') {
        notification.classList.add('warning');
      }
      
      // Show notification
      notification.classList.remove('hidden');
      
      // Auto hide setelah 5 detik
      setTimeout(() => {
        notification.classList.add('hidden');
      }, 5000);
    }

    // === CSV IMPORT FUNCTIONS ===

    function generateId() {
      return 'ID_' + Math.random().toString(36).substr(2, 9);
    }

    function downloadTemplateEkstra() {
      try {
        const csv = 'nama,pembina\nBasket,Pak Budi\nFutsal,Pak Ahmad\nPramuka,Bu Siti';
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.style.display = 'none';
        link.href = url;
        link.download = 'template_ekstra.csv';
        link.setAttribute('target', '_blank');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => {
          URL.revokeObjectURL(url);
        }, 250);
        showToast('‚úÖ Download dimulai: template_ekstra.csv');
      } catch (error) {
        showToast('‚ùå Gagal download: ' + error.message);
      }
    }

    function downloadTemplateAnggota() {
      try {
        const csv = 'nama,kelas,ekstra\nAndi Pratama,X-1,Basket\nBudi Santoso,X-2,Futsal\nCitra Dewi,XI-1,Pramuka';
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.style.display = 'none';
        link.href = url;
        link.download = 'template_anggota.csv';
        link.setAttribute('target', '_blank');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => {
          URL.revokeObjectURL(url);
        }, 250);
        showToast('‚úÖ Download dimulai: template_anggota.csv');
      } catch (error) {
        showToast('‚ùå Gagal download: ' + error.message);
      }
    }

    function openImportEkstraModal() {
      document.getElementById('preview-ekstra').classList.add('hidden');
      document.getElementById('no-preview-ekstra').classList.remove('hidden');
      document.getElementById('file-ekstra').value = '';
      importEkstraQueue = [];
      document.getElementById('modal-import-ekstra').classList.remove('hidden');
    }

    function openImportAnggotaModal() {
      document.getElementById('preview-anggota').classList.add('hidden');
      document.getElementById('no-preview-anggota').classList.remove('hidden');
      document.getElementById('file-anggota').value = '';
      importAnggotaQueue = [];
      document.getElementById('modal-import-anggota').classList.remove('hidden');
    }

    function handleFileEkstra(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        
        // Skip header
        const dataLines = lines.slice(1);
        
        importEkstraQueue = [];
        const tbody = document.getElementById('tbody-preview-ekstra');
        tbody.innerHTML = '';

        dataLines.forEach(line => {
          const parts = line.split(',').map(p => p.trim());
          if (parts.length >= 2 && parts[0] && parts[1]) {
            const data = {
              nama: parts[0],
              pembina: parts[1]
            };
            importEkstraQueue.push(data);

            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
              <td class="px-4 py-3 text-sm text-gray-800">${data.nama}</td>
              <td class="px-4 py-3 text-sm text-gray-600">${data.pembina}</td>
            `;
            tbody.appendChild(tr);
          }
        });

        if (importEkstraQueue.length > 0) {
          document.getElementById('filename-ekstra').textContent = file.name;
          document.getElementById('count-ekstra').textContent = importEkstraQueue.length;
          document.getElementById('preview-ekstra').classList.remove('hidden');
          document.getElementById('no-preview-ekstra').classList.add('hidden');
        } else {
          showToast('File CSV tidak memiliki data yang valid!');
        }
      };
      reader.readAsText(file);
    }

    function handleFileAnggota(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        
        // Skip header
        const dataLines = lines.slice(1);
        
        importAnggotaQueue = [];
        const tbody = document.getElementById('tbody-preview-anggota');
        tbody.innerHTML = '';

        const ekstraList = allData.filter(d => d.type === 'ekstra').map(e => e.nama);
        const invalidEkstra = new Set();

        dataLines.forEach(line => {
          const parts = line.split(',').map(p => p.trim());
          if (parts.length >= 3 && parts[0] && parts[1] && parts[2]) {
            const data = {
              nama: parts[0],
              kelas: parts[1],
              ekstra: parts[2]
            };
            
            if (!ekstraList.includes(data.ekstra)) {
              invalidEkstra.add(data.ekstra);
            }

            importAnggotaQueue.push(data);

            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            const isInvalid = !ekstraList.includes(data.ekstra);
            tr.innerHTML = `
              <td class="px-4 py-3 text-sm text-gray-800">${data.nama}</td>
              <td class="px-4 py-3 text-sm text-gray-600">${data.kelas}</td>
              <td class="px-4 py-3 text-sm ${isInvalid ? 'text-red-600 font-semibold' : 'text-gray-600'}">${data.ekstra} ${isInvalid ? '‚ùå' : ''}</td>
            `;
            tbody.appendChild(tr);
          }
        });

        if (importAnggotaQueue.length > 0) {
          document.getElementById('filename-anggota').textContent = file.name;
          document.getElementById('count-anggota').textContent = importAnggotaQueue.length;
          
          if (invalidEkstra.size > 0) {
            document.getElementById('warning-anggota').classList.remove('hidden');
            document.getElementById('warning-text-anggota').innerHTML = 
              `Ekstrakurikuler tidak ditemukan: <strong>${Array.from(invalidEkstra).join(', ')}</strong>. Tambahkan dulu di menu "Jenis Ekstra" atau hapus dari CSV.`;
          } else {
            document.getElementById('warning-anggota').classList.add('hidden');
          }

          document.getElementById('preview-anggota').classList.remove('hidden');
          document.getElementById('no-preview-anggota').classList.add('hidden');
        } else {
          showToast('File CSV tidak memiliki data yang valid!');
        }
      };
      reader.readAsText(file);
    }

    async function importEkstraData() {
      const btn = document.getElementById('btn-import-ekstra');
      btn.disabled = true;
      btn.textContent = 'Mengimport...';

      showLoading(true);

      let successCount = 0;
      let failCount = 0;

      for (const data of importEkstraQueue) {
        const success = await createRecord('ekstra', data);
        if (success) {
          successCount++;
        } else {
          failCount++;
        }
      }

      showLoading(false);
      btn.disabled = false;
      btn.textContent = 'Import Semua Data';

      closeModal('modal-import-ekstra');
      showToast(`Import selesai! Berhasil: ${successCount}, Gagal: ${failCount}`);
    }

    async function importAnggotaData() {
      const ekstraList = allData.filter(d => d.type === 'ekstra').map(e => e.nama);
      const invalidData = importAnggotaQueue.filter(d => !ekstraList.includes(d.ekstra));

      if (invalidData.length > 0) {
        showToast('Gagal import! Ada ekstrakurikuler yang tidak terdaftar.');
        return;
      }

      const btn = document.getElementById('btn-import-anggota');
      btn.disabled = true;
      btn.textContent = 'Mengimport...';

      showLoading(true);

      let successCount = 0;
      let failCount = 0;

      for (const data of importAnggotaQueue) {
        const success = await createRecord('anggota', data);
        if (success) {
          successCount++;
        } else {
          failCount++;
        }
      }

      showLoading(false);
      btn.disabled = false;
      btn.textContent = 'Import Semua Data';

      closeModal('modal-import-anggota');
      showToast(`Import selesai! Berhasil: ${successCount}, Gagal: ${failCount}`);
    }

    // === UI UPDATE FUNCTIONS ===

    function updateUI() {
      const currentPage = document.querySelector('.menu-item.active').dataset.page;
      
      if (currentPage === 'anggota') {
        renderAnggotaTable();
      } else if (currentPage === 'ekstra') {
        renderEkstraTable();
      } else if (currentPage === 'penilaian') {
        renderPenilaianTable();
      } else if (currentPage === 'absensi') {
        renderAbsensiTable();
      } else if (currentPage === 'jurnal') {
        renderJurnalList();
      }
      
      updateKelasDatalist();
      updateAnggotaEkstraSelect();
      updateEkstraSelects();
      updateFilterSelects();
    }

    function updateDashboard() {
      const anggota = allData.filter(d => d.type === 'anggota');
      const ekstra = allData.filter(d => d.type === 'ekstra');
      const penilaian = allData.filter(d => d.type === 'penilaian');
      const jurnal = allData.filter(d => d.type === 'jurnal');

      document.getElementById('stat-anggota').textContent = anggota.length;
      document.getElementById('stat-ekstra').textContent = ekstra.length;
      document.getElementById('stat-penilaian').textContent = penilaian.length;
      document.getElementById('stat-jurnal').textContent = jurnal.length;
    }

    function updateDistribution() {
      const anggota = allData.filter(d => d.type === 'anggota');
      const distribution = {};
      
      anggota.forEach(a => {
        distribution[a.ekstra] = (distribution[a.ekstra] || 0) + 1;
      });

      const container = document.getElementById('distribution-chart');
      
      if (Object.keys(distribution).length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">Belum ada data</p>';
        return;
      }

      const total = anggota.length;
      let html = '';
      
      Object.entries(distribution).forEach(([ekstra, count]) => {
        const percentage = ((count / total) * 100).toFixed(1);
        html += `
          <div class="mb-3">
            <div class="flex justify-between mb-1">
              <span class="text-sm font-medium text-gray-700">${ekstra}</span>
              <span class="text-sm text-gray-600">${count} siswa (${percentage}%)</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="progress-bar bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function updateRecentActivity() {
      const recent = [...allData].slice(-5).reverse();

      const container = document.getElementById('recent-activity');
      
      if (recent.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">Belum ada aktivitas</p>';
        return;
      }

      let html = '';
      recent.forEach(item => {
        let icon = 'üìù';
        let text = '';
        
        if (item.type === 'anggota') {
          icon = 'üë§';
          text = `${item.nama} bergabung dengan ${item.ekstra}`;
        } else if (item.type === 'ekstra') {
          icon = 'üéØ';
          text = `Ekstrakurikuler ${item.nama} ditambahkan`;
        } else if (item.type === 'penilaian') {
          icon = '‚≠ê';
          text = `Penilaian ${item.nilai} untuk ${item.nama}`;
        } else if (item.type === 'absensi') {
          icon = '‚úì';
          text = `Absensi ${item.nama} - ${item.status}`;
        } else if (item.type === 'jurnal') {
          icon = 'üìî';
          text = `Jurnal: ${item.kegiatan}`;
        }

        html += `
          <div class="flex items-start gap-3 p-3 rounded-lg bg-gray-50">
            <span class="text-2xl">${icon}</span>
            <div class="flex-1">
              <p class="text-sm text-gray-800">${text}</p>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function renderAnggotaTable() {
      const searchValue = document.getElementById('search-anggota') ? document.getElementById('search-anggota').value.toLowerCase() : '';
      
      let anggota = allData.filter(d => d.type === 'anggota');
      
      // Filter berdasarkan search
      if (searchValue) {
        anggota = anggota.filter(a => 
          a.nama.toLowerCase().includes(searchValue) || 
          a.ekstra.toLowerCase().includes(searchValue)
        );
      }
      
      anggota = anggota.sort((a, b) => {
        const kelasCompare = a.kelas.localeCompare(b.kelas);
        if (kelasCompare !== 0) return kelasCompare;
        return a.nama.localeCompare(b.nama);
      });
      
      const tbody = document.getElementById('anggota-table');
      
      if (anggota.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">Tidak ada data yang ditemukan</td></tr>';
        return;
      }

      tbody.innerHTML = anggota.map(a => `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 text-sm text-gray-800">${a.nama}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${a.kelas}</td>
          <td class="px-6 py-4">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
              ${a.ekstra}
            </span>
          </td>
          <td class="px-6 py-4 text-center">
            <button onclick='editAnggota(${JSON.stringify(a).replace(/'/g, "&apos;")})' class="text-blue-600 hover:text-blue-800 font-medium text-sm mr-3">Edit</button>
            <button onclick='showConfirmDelete("anggota", "${a.id}")' class="text-red-600 hover:text-red-800 font-medium text-sm">Hapus</button>
          </td>
        </tr>
      `).join('');
    }

    function clearSearchAnggota() {
      document.getElementById('search-anggota').value = '';
      renderAnggotaTable();
    }

    function renderEkstraTable() {
      const ekstra = allData.filter(d => d.type === 'ekstra')
        .sort((a, b) => a.nama.localeCompare(b.nama));
      
      const tbody = document.getElementById('ekstra-table');
      
      if (ekstra.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-8 text-center text-gray-500">Belum ada data ekstrakurikuler</td></tr>';
        return;
      }

      tbody.innerHTML = ekstra.map(e => `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 text-sm font-medium text-gray-800">${e.nama}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${e.pembina}</td>
          <td class="px-6 py-4 text-center">
            <button onclick='editEkstra(${JSON.stringify(e).replace(/'/g, "&apos;")})' class="text-blue-600 hover:text-blue-800 font-medium text-sm mr-3">Edit</button>
            <button onclick='showConfirmDelete("ekstra", "${e.id}")' class="text-red-600 hover:text-red-800 font-medium text-sm">Hapus</button>
          </td>
        </tr>
      `).join('');
    }

    function renderPenilaianTable() {
      const penilaian = allData.filter(d => d.type === 'penilaian')
        .sort((a, b) => {
          const kelasCompare = a.kelas.localeCompare(b.kelas);
          if (kelasCompare !== 0) return kelasCompare;
          return a.nama.localeCompare(b.nama);
        });
      const tbody = document.getElementById('penilaian-table');
      
      if (penilaian.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada data penilaian</td></tr>';
        return;
      }

      tbody.innerHTML = penilaian.map(p => {
        let badgeColor = 'bg-gray-100 text-gray-800';
        if (p.nilai === 'Sangat Baik') badgeColor = 'bg-green-100 text-green-800';
        else if (p.nilai === 'Baik') badgeColor = 'bg-blue-100 text-blue-800';
        else if (p.nilai === 'Sedang') badgeColor = 'bg-yellow-100 text-yellow-800';
        else if (p.nilai === 'Cukup') badgeColor = 'bg-orange-100 text-orange-800';

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 text-sm text-gray-800">${p.nama}</td>
            <td class="px-6 py-4 text-sm text-gray-600">${p.kelas}</td>
            <td class="px-6 py-4 text-sm text-gray-600">${p.ekstra}</td>
            <td class="px-6 py-4">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${badgeColor}">
                ${p.nilai}
              </span>
            </td>
            <td class="px-6 py-4 text-sm text-gray-600">${p.catatan || '-'}</td>
            <td class="px-6 py-4 text-center">
              <button onclick='editPenilaian(${JSON.stringify(p).replace(/'/g, "&apos;")})' class="text-blue-600 hover:text-blue-800 font-medium text-sm">Edit</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderAbsensiTable() {
      const absensi = allData.filter(d => d.type === 'absensi')
        .sort((a, b) => {
          const kelasCompare = a.kelas.localeCompare(b.kelas);
          if (kelasCompare !== 0) return kelasCompare;
          return a.nama.localeCompare(b.nama);
        });
      const tbody = document.getElementById('absensi-table');
      
      if (absensi.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada data absensi</td></tr>';
        return;
      }

      tbody.innerHTML = absensi.map(a => {
        let badgeColor = 'bg-gray-100 text-gray-800';
        if (a.status === 'H') badgeColor = 'bg-green-100 text-green-800';
        else if (a.status === 'S') badgeColor = 'bg-yellow-100 text-yellow-800';
        else if (a.status === 'I') badgeColor = 'bg-blue-100 text-blue-800';
        else if (a.status === 'A') badgeColor = 'bg-red-100 text-red-800';

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 text-sm text-gray-800">${a.tanggal}</td>
            <td class="px-6 py-4 text-sm text-gray-800">${a.nama}</td>
            <td class="px-6 py-4 text-sm text-gray-600">${a.kelas}</td>
            <td class="px-6 py-4 text-sm text-gray-600">${a.ekstra}</td>
            <td class="px-6 py-4 text-center">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${badgeColor}">
                ${a.status}
              </span>
            </td>
            <td class="px-6 py-4 text-center">
              <button onclick='editAbsensi(${JSON.stringify(a).replace(/'/g, "&apos;")})' class="text-blue-600 hover:text-blue-800 font-medium text-sm">Edit</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderJurnalList() {
      const jurnal = allData.filter(d => d.type === 'jurnal').reverse();
      const list = document.getElementById('jurnal-list');
      
      if (jurnal.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada jurnal kegiatan</p>';
        return;
      }

      list.innerHTML = jurnal.map(j => `
        <div class="bg-white rounded-xl shadow-md p-6">
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1">
              <h4 class="text-lg font-bold text-gray-800 mb-1">${j.kegiatan}</h4>
              <div class="flex items-center gap-4 text-sm text-gray-600">
                <span>üìÖ ${j.tanggal}</span>
                <span>üéØ ${j.ekstra}</span>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick='editJurnal(${JSON.stringify(j).replace(/'/g, "&apos;")})' class="text-blue-600 hover:text-blue-800">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              <button onclick='showConfirmDelete("jurnal", "${j.id}")' class="text-red-600 hover:text-red-800">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </div>
          <p class="text-gray-600">${j.deskripsi}</p>
        </div>
      `).join('');
    }

    function updateKelasDatalist() {
      const anggota = allData.filter(d => d.type === 'anggota');
      const kelasList = [...new Set(anggota.map(a => a.kelas))].sort();
      
      const dropdown = document.getElementById('kelas-dropdown');
      dropdown.innerHTML = kelasList.map(k => 
        `<div class="datalist-option" onclick="selectKelas('${k}')">${k}</div>`
      ).join('');
    }

    function updateAnggotaEkstraSelect() {
      const ekstra = allData.filter(d => d.type === 'ekstra').sort((a, b) => a.nama.localeCompare(b.nama));
      const select = document.getElementById('anggota-ekstra');
      if (select) {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Pilih ekstrakurikuler</option>' + 
          ekstra.map(e => `<option value="${e.nama}">${e.nama}</option>`).join('');
        if (currentValue && ekstra.some(e => e.nama === currentValue)) {
          select.value = currentValue;
        }
      }
    }

    function updateEkstraSelects() {
      const ekstra = allData.filter(d => d.type === 'ekstra').sort((a, b) => a.nama.localeCompare(b.nama));
      const selects = ['penilaian-ekstra', 'absensi-ekstra', 'jurnal-ekstra', 'penilaian-select-ekstra', 'absensi-select-ekstra'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          const currentValue = select.value;
          select.innerHTML = '<option value="">Pilih ekstrakurikuler</option>' + 
            ekstra.map(e => `<option value="${e.nama}">${e.nama}</option>`).join('');
          if (currentValue) select.value = currentValue;
        }
      });
    }

    function updateFilterSelects() {
      const ekstra = allData.filter(d => d.type === 'ekstra').sort((a, b) => a.nama.localeCompare(b.nama));
      
      const filterKehadiranEkstra = document.getElementById('filter-kehadiran-ekstra');
      const filterJurnalEkstra = document.getElementById('filter-jurnal-ekstra');
      
      const ekstraOptions = '<option value="">Semua Ekstra</option>' + 
        ekstra.map(e => `<option value="${e.nama}">${e.nama}</option>`).join('');
      
      filterKehadiranEkstra.innerHTML = ekstraOptions;
      filterJurnalEkstra.innerHTML = ekstraOptions;
    }

    // === DATALIST HANDLERS ===

    document.getElementById('anggota-kelas').addEventListener('input', function() {
      const dropdown = document.getElementById('kelas-dropdown');
      const value = this.value.toLowerCase();
      
      if (value.length > 0) {
        const options = dropdown.querySelectorAll('.datalist-option');
        let hasMatch = false;
        
        options.forEach(option => {
          if (option.textContent.toLowerCase().includes(value)) {
            option.style.display = 'block';
            hasMatch = true;
          } else {
            option.style.display = 'none';
          }
        });
        
        dropdown.classList.toggle('show', hasMatch || value.length > 0);
      } else {
        dropdown.classList.add('show');
        dropdown.querySelectorAll('.datalist-option').forEach(o => o.style.display = 'block');
      }
    });

    document.getElementById('anggota-kelas').addEventListener('focus', function() {
      document.getElementById('kelas-dropdown').classList.add('show');
    });

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.datalist-input')) {
        document.querySelectorAll('.datalist-dropdown').forEach(d => d.classList.remove('show'));
      }
    });

    function selectKelas(kelas) {
      document.getElementById('anggota-kelas').value = kelas;
      document.getElementById('kelas-dropdown').classList.remove('show');
    }

    // === DROPDOWN CHANGE HANDLERS ===

    document.getElementById('penilaian-ekstra').addEventListener('change', function() {
      const selectedEkstra = this.value;
      const anggota = allData.filter(d => d.type === 'anggota' && d.ekstra === selectedEkstra)
        .sort((a, b) => {
          const kelasCompare = a.kelas.localeCompare(b.kelas);
          if (kelasCompare !== 0) return kelasCompare;
          return a.nama.localeCompare(b.nama);
        });
      
      const select = document.getElementById('penilaian-nama');
      select.innerHTML = '<option value="">Pilih siswa</option>' + 
        anggota.map(a => `<option value="${a.nama}" data-kelas="${a.kelas}" data-ekstra="${a.ekstra}">${a.nama} - ${a.kelas}</option>`).join('');
    });

    document.getElementById('absensi-ekstra').addEventListener('change', function() {
      const selectedEkstra = this.value;
      const anggota = allData.filter(d => d.type === 'anggota' && d.ekstra === selectedEkstra)
        .sort((a, b) => {
          const kelasCompare = a.kelas.localeCompare(b.kelas);
          if (kelasCompare !== 0) return kelasCompare;
          return a.nama.localeCompare(b.nama);
        });
      
      const select = document.getElementById('absensi-nama');
      select.innerHTML = '<option value="">Pilih siswa</option>' + 
        anggota.map(a => `<option value="${a.nama}" data-kelas="${a.kelas}" data-ekstra="${a.ekstra}">${a.nama} - ${a.kelas}</option>`).join('');
    });

    // === INPUT KLASIKAL HANDLERS ===

    document.getElementById('penilaian-select-ekstra').addEventListener('change', function() {
      const selectedEkstra = this.value;
      
      if (!selectedEkstra) {
        document.getElementById('penilaian-klasikal-container').classList.add('hidden');
        document.getElementById('penilaian-no-ekstra').classList.remove('hidden');
        return;
      }

      const anggota = allData.filter(d => d.type === 'anggota' && d.ekstra === selectedEkstra)
        .sort((a, b) => {
          // Urutkan berdasarkan kelas dulu (A-Z)
          const kelasCompare = a.kelas.localeCompare(b.kelas);
          if (kelasCompare !== 0) return kelasCompare;
          // Kalau kelas sama, urutkan berdasarkan nama (A-Z)
          return a.nama.localeCompare(b.nama);
        });

      if (anggota.length === 0) {
        showToast('Tidak ada anggota di ekstrakurikuler ini');
        return;
      }

      const tbody = document.getElementById('penilaian-klasikal-tbody');
      tbody.innerHTML = anggota.map(a => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-sm text-gray-800">${a.nama}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${a.kelas}</td>
          <td class="px-4 py-3">
            <select class="penilaian-nilai-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" data-nama="${a.nama}" data-kelas="${a.kelas}" data-ekstra="${a.ekstra}">
              <option value="Sangat Baik">Sangat Baik</option>
              <option value="Baik" selected>Baik</option>
              <option value="Sedang">Sedang</option>
              <option value="Cukup">Cukup</option>
            </select>
          </td>
          <td class="px-4 py-3">
            <input type="text" class="penilaian-catatan-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" placeholder="Catatan..." data-nama="${a.nama}" />
          </td>
        </tr>
      `).join('');

      document.getElementById('penilaian-no-ekstra').classList.add('hidden');
      document.getElementById('penilaian-klasikal-container').classList.remove('hidden');
    });

    document.getElementById('absensi-select-ekstra').addEventListener('change', function() {
      const selectedEkstra = this.value;
      const tanggal = document.getElementById('absensi-tanggal-klasikal').value;
      
      if (!selectedEkstra || !tanggal) {
        document.getElementById('absensi-klasikal-container').classList.add('hidden');
        document.getElementById('absensi-no-ekstra').classList.remove('hidden');
        return;
      }

      const anggota = allData.filter(d => d.type === 'anggota' && d.ekstra === selectedEkstra)
        .sort((a, b) => {
          // Urutkan berdasarkan kelas dulu (A-Z)
          const kelasCompare = a.kelas.localeCompare(b.kelas);
          if (kelasCompare !== 0) return kelasCompare;
          // Kalau kelas sama, urutkan berdasarkan nama (A-Z)
          return a.nama.localeCompare(b.nama);
        });

      if (anggota.length === 0) {
        showToast('Tidak ada anggota di ekstrakurikuler ini');
        return;
      }

      const tbody = document.getElementById('absensi-klasikal-tbody');
      tbody.innerHTML = anggota.map(a => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-sm text-gray-800">${a.nama}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${a.kelas}</td>
          <td class="px-4 py-3 text-center">
            <select class="absensi-status-input px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" data-nama="${a.nama}" data-kelas="${a.kelas}" data-ekstra="${a.ekstra}">
              <option value="H" selected>Hadir (H)</option>
              <option value="S">Sakit (S)</option>
              <option value="I">Izin (I)</option>
              <option value="A">Alpa (A)</option>
            </select>
          </td>
        </tr>
      `).join('');

      document.getElementById('absensi-no-ekstra').classList.add('hidden');
      document.getElementById('absensi-klasikal-container').classList.remove('hidden');
    });

    document.getElementById('absensi-tanggal-klasikal').addEventListener('change', function() {
      const ekstra = document.getElementById('absensi-select-ekstra').value;
      if (ekstra) {
        document.getElementById('absensi-select-ekstra').dispatchEvent(new Event('change'));
      }
    });

    // === FILTER FUNCTIONS ===

    function applyFilterKehadiran() {
      const nama = document.getElementById('filter-kehadiran-nama').value.toLowerCase();
      const kelas = document.getElementById('filter-kehadiran-kelas').value.toLowerCase();
      const ekstra = document.getElementById('filter-kehadiran-ekstra').value;
      const status = document.getElementById('filter-kehadiran-status').value;
      const dari = document.getElementById('filter-kehadiran-dari').value;
      const sampai = document.getElementById('filter-kehadiran-sampai').value;

      let filtered = allData.filter(d => d.type === 'absensi');

      if (nama) filtered = filtered.filter(d => d.nama.toLowerCase().includes(nama));
      if (kelas) filtered = filtered.filter(d => d.kelas.toLowerCase().includes(kelas));
      if (ekstra) filtered = filtered.filter(d => d.ekstra === ekstra);
      if (status) filtered = filtered.filter(d => d.status === status);
      if (dari) filtered = filtered.filter(d => d.tanggal >= dari);
      if (sampai) filtered = filtered.filter(d => d.tanggal <= sampai);

      filteredKehadiranData = filtered;
      renderKehadiranTable(filtered);
    }

    function renderKehadiranTable(data) {
      const tbody = document.getElementById('tbody-kehadiran');
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-gray-500">Tidak ada data</td></tr>';
        return;
      }

      tbody.innerHTML = data.map((d, index) => {
        let badgeColor = 'bg-gray-100 text-gray-800';
        if (d.status === 'H') badgeColor = 'bg-green-100 text-green-800';
        else if (d.status === 'S') badgeColor = 'bg-yellow-100 text-yellow-800';
        else if (d.status === 'I') badgeColor = 'bg-blue-100 text-blue-800';
        else if (d.status === 'A') badgeColor = 'bg-red-100 text-red-800';

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm text-gray-800">${index + 1}</td>
            <td class="px-4 py-3 text-sm text-gray-800">${d.tanggal}</td>
            <td class="px-4 py-3 text-sm text-gray-800">${d.nama}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${d.kelas}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${d.ekstra}</td>
            <td class="px-4 py-3 text-center">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${badgeColor}">
                ${getStatusText(d.status)}
              </span>
            </td>
          </tr>
        `;
      }).join('');
    }

    function applyFilterJurnal() {
      const ekstra = document.getElementById('filter-jurnal-ekstra').value;
      const dari = document.getElementById('filter-jurnal-dari').value;
      const sampai = document.getElementById('filter-jurnal-sampai').value;

      let filtered = allData.filter(d => d.type === 'jurnal');

      if (ekstra) filtered = filtered.filter(d => d.ekstra === ekstra);
      if (dari) filtered = filtered.filter(d => d.tanggal >= dari);
      if (sampai) filtered = filtered.filter(d => d.tanggal <= sampai);

      filteredJurnalData = filtered;
      renderJurnalTable(filtered);
    }

    function renderJurnalTable(data) {
      const tbody = document.getElementById('tbody-jurnal');
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">Tidak ada data</td></tr>';
        return;
      }

      tbody.innerHTML = data.map((d, index) => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-sm text-gray-800">${index + 1}</td>
          <td class="px-4 py-3 text-sm text-gray-800">${d.tanggal}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${d.ekstra}</td>
          <td class="px-4 py-3 text-sm text-gray-800">${d.kegiatan}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${d.deskripsi}</td>
        </tr>
      `).join('');
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // === NAVIGATION ===

    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        this.classList.add('active');
        
        const page = this.dataset.page;
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
        document.getElementById('page-' + page).classList.remove('hidden');
        
        updateUI();
      });
    });

    // === MODAL FUNCTIONS ===

    function openAddAnggotaModal() {
      document.getElementById('modal-anggota-title').textContent = 'Tambah Anggota';
      document.getElementById('form-anggota').reset();
      document.getElementById('anggota-id').value = '';
      updateAnggotaEkstraSelect();
      document.getElementById('modal-anggota').classList.remove('hidden');
    }

    function openAddEkstraModal() {
      document.getElementById('modal-ekstra-title').textContent = 'Tambah Ekstrakurikuler';
      document.getElementById('form-ekstra').reset();
      document.getElementById('ekstra-id').value = '';
      document.getElementById('modal-ekstra').classList.remove('hidden');
    }

    function openAddPenilaianModal() {
      document.getElementById('modal-penilaian-title').textContent = 'Tambah Penilaian';
      document.getElementById('form-penilaian').reset();
      document.getElementById('penilaian-id').value = '';
      document.getElementById('penilaian-nilai').value = 'Baik';
      
      // Buka kunci semua field untuk mode tambah
      document.getElementById('penilaian-ekstra').disabled = false;
      document.getElementById('penilaian-nama').disabled = false;
      
      // Kembalikan style normal
      document.getElementById('penilaian-ekstra').style.backgroundColor = '';
      document.getElementById('penilaian-ekstra').style.color = '';
      document.getElementById('penilaian-nama').style.backgroundColor = '';
      document.getElementById('penilaian-nama').style.color = '';
      
      document.getElementById('modal-penilaian').classList.remove('hidden');
    }

    function openAddAbsensiModal() {
      document.getElementById('modal-absensi-title').textContent = 'Tambah Absensi';
      document.getElementById('form-absensi').reset();
      document.getElementById('absensi-id').value = '';
      document.getElementById('absensi-tanggal').value = new Date().toISOString().split('T')[0];
      document.getElementById('absensi-status').value = 'H';
      
      // Buka kunci semua field untuk mode tambah
      document.getElementById('absensi-tanggal').disabled = false;
      document.getElementById('absensi-ekstra').disabled = false;
      document.getElementById('absensi-nama').disabled = false;
      
      // Kembalikan style normal
      document.getElementById('absensi-tanggal').style.backgroundColor = '';
      document.getElementById('absensi-tanggal').style.color = '';
      document.getElementById('absensi-ekstra').style.backgroundColor = '';
      document.getElementById('absensi-ekstra').style.color = '';
      document.getElementById('absensi-nama').style.backgroundColor = '';
      document.getElementById('absensi-nama').style.color = '';
      
      document.getElementById('modal-absensi').classList.remove('hidden');
    }

    function openAddJurnalModal() {
      document.getElementById('modal-jurnal-title').textContent = 'Tambah Jurnal';
      document.getElementById('form-jurnal').reset();
      document.getElementById('jurnal-id').value = '';
      document.getElementById('jurnal-tanggal').value = new Date().toISOString().split('T')[0];
      document.getElementById('modal-jurnal').classList.remove('hidden');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    function editAnggota(data) {
      document.getElementById('modal-anggota-title').textContent = 'Edit Anggota';
      document.getElementById('anggota-id').value = data.id;
      document.getElementById('anggota-nama').value = data.nama;
      document.getElementById('anggota-kelas').value = data.kelas;
      updateAnggotaEkstraSelect();
      document.getElementById('anggota-ekstra').value = data.ekstra;
      document.getElementById('modal-anggota').classList.remove('hidden');
    }

    function editEkstra(data) {
      document.getElementById('modal-ekstra-title').textContent = 'Edit Ekstrakurikuler';
      document.getElementById('ekstra-id').value = data.id;
      document.getElementById('ekstra-nama').value = data.nama;
      document.getElementById('ekstra-pembina').value = data.pembina;
      document.getElementById('modal-ekstra').classList.remove('hidden');
    }

    function editPenilaian(data) {
      document.getElementById('modal-penilaian-title').textContent = 'Edit Penilaian';
      document.getElementById('penilaian-id').value = data.id;
      
      // Set nilai ekstra dan trigger change untuk populate nama
      document.getElementById('penilaian-ekstra').value = data.ekstra;
      document.getElementById('penilaian-ekstra').dispatchEvent(new Event('change'));
      
      setTimeout(() => {
        // Set nilai nama setelah dropdown terisi
        document.getElementById('penilaian-nama').value = data.nama;
        
        // Kunci field ekstra dan nama (tidak bisa diedit tapi tetap tampil)
        document.getElementById('penilaian-ekstra').disabled = true;
        document.getElementById('penilaian-nama').disabled = true;
        
        // Ubah style jadi abu-abu untuk visual kunci
        document.getElementById('penilaian-ekstra').style.backgroundColor = '#f3f4f6';
        document.getElementById('penilaian-ekstra').style.color = '#6b7280';
        document.getElementById('penilaian-nama').style.backgroundColor = '#f3f4f6';
        document.getElementById('penilaian-nama').style.color = '#6b7280';
        
        // Set field yang bisa diedit
        document.getElementById('penilaian-nilai').value = data.nilai;
        document.getElementById('penilaian-catatan').value = data.catatan;
      }, 100);
      
      document.getElementById('modal-penilaian').classList.remove('hidden');
    }

    function editAbsensi(data) {
      document.getElementById('modal-absensi-title').textContent = 'Edit Absensi';
      document.getElementById('absensi-id').value = data.id;
      document.getElementById('absensi-tanggal').value = data.tanggal;
      
      // Set nilai ekstra dan trigger change untuk populate nama
      document.getElementById('absensi-ekstra').value = data.ekstra;
      document.getElementById('absensi-ekstra').dispatchEvent(new Event('change'));
      
      setTimeout(() => {
        // Set nilai nama setelah dropdown terisi
        document.getElementById('absensi-nama').value = data.nama;
        
        // Kunci field tanggal, ekstra, dan nama (tidak bisa diedit tapi tetap tampil)
        document.getElementById('absensi-tanggal').disabled = true;
        document.getElementById('absensi-ekstra').disabled = true;
        document.getElementById('absensi-nama').disabled = true;
        
        // Ubah style jadi abu-abu untuk visual kunci
        document.getElementById('absensi-tanggal').style.backgroundColor = '#f3f4f6';
        document.getElementById('absensi-tanggal').style.color = '#6b7280';
        document.getElementById('absensi-ekstra').style.backgroundColor = '#f3f4f6';
        document.getElementById('absensi-ekstra').style.color = '#6b7280';
        document.getElementById('absensi-nama').style.backgroundColor = '#f3f4f6';
        document.getElementById('absensi-nama').style.color = '#6b7280';
        
        // Set field yang bisa diedit
        document.getElementById('absensi-status').value = data.status;
      }, 100);
      
      document.getElementById('modal-absensi').classList.remove('hidden');
    }

    function editJurnal(data) {
      document.getElementById('modal-jurnal-title').textContent = 'Edit Jurnal';
      document.getElementById('jurnal-id').value = data.id;
      document.getElementById('jurnal-tanggal').value = data.tanggal;
      document.getElementById('jurnal-ekstra').value = data.ekstra;
      document.getElementById('jurnal-kegiatan').value = data.kegiatan;
      document.getElementById('jurnal-deskripsi').value = data.deskripsi;
      document.getElementById('modal-jurnal').classList.remove('hidden');
    }

    // === FORM SUBMISSIONS ===

    document.getElementById('form-penilaian-klasikal').addEventListener('submit', async function(e) {
      e.preventDefault();

      const btn = document.getElementById('btn-save-penilaian-klasikal');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const nilaiInputs = document.querySelectorAll('.penilaian-nilai-input');
      const catatanInputs = document.querySelectorAll('.penilaian-catatan-input');

      let successCount = 0;
      let failCount = 0;

      for (let i = 0; i < nilaiInputs.length; i++) {
        const nilaiInput = nilaiInputs[i];
        const catatanInput = catatanInputs[i];

        const data = {
          nama: nilaiInput.dataset.nama,
          kelas: nilaiInput.dataset.kelas,
          ekstra: nilaiInput.dataset.ekstra,
          nilai: nilaiInput.value,
          catatan: catatanInput.value
        };

        const success = await createRecord('penilaian', data);
        if (success) successCount++;
        else failCount++;
      }

      btn.disabled = false;
      btn.textContent = 'üíæ Simpan Semua Penilaian';

      showToast(`Selesai! Berhasil: ${successCount}, Gagal: ${failCount}`);
      
      document.getElementById('penilaian-select-ekstra').value = '';
      document.getElementById('penilaian-klasikal-container').classList.add('hidden');
      document.getElementById('penilaian-no-ekstra').classList.remove('hidden');
    });

    document.getElementById('form-absensi-klasikal').addEventListener('submit', async function(e) {
      e.preventDefault();

      const btn = document.getElementById('btn-save-absensi-klasikal');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const tanggal = document.getElementById('absensi-tanggal-klasikal').value;
      const statusInputs = document.querySelectorAll('.absensi-status-input');

      let successCount = 0;
      let failCount = 0;

      for (let i = 0; i < statusInputs.length; i++) {
        const statusInput = statusInputs[i];

        const data = {
          tanggal: tanggal,
          nama: statusInput.dataset.nama,
          kelas: statusInput.dataset.kelas,
          ekstra: statusInput.dataset.ekstra,
          status: statusInput.value
        };

        const success = await createRecord('absensi', data);
        if (success) successCount++;
        else failCount++;
      }

      btn.disabled = false;
      btn.textContent = 'üíæ Simpan Semua Absensi';

      showToast(`Selesai! Berhasil: ${successCount}, Gagal: ${failCount}`);
      
      document.getElementById('absensi-select-ekstra').value = '';
      document.getElementById('absensi-klasikal-container').classList.add('hidden');
      document.getElementById('absensi-no-ekstra').classList.remove('hidden');
    });

    document.getElementById('form-anggota').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btn = document.getElementById('btn-save-anggota');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const id = document.getElementById('anggota-id').value;
      const data = {
        nama: document.getElementById('anggota-nama').value,
        kelas: document.getElementById('anggota-kelas').value,
        ekstra: document.getElementById('anggota-ekstra').value
      };

      let success;
      if (id) {
        success = await updateRecord('anggota', id, data);
      } else {
        success = await createRecord('anggota', data);
      }

      btn.disabled = false;
      btn.textContent = 'Simpan';

      if (success) {
        closeModal('modal-anggota');
      }
    });

    document.getElementById('form-ekstra').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btn = document.getElementById('btn-save-ekstra');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const id = document.getElementById('ekstra-id').value;
      const data = {
        nama: document.getElementById('ekstra-nama').value,
        pembina: document.getElementById('ekstra-pembina').value
      };

      let success;
      if (id) {
        success = await updateRecord('ekstra', id, data);
      } else {
        success = await createRecord('ekstra', data);
      }

      btn.disabled = false;
      btn.textContent = 'Simpan';

      if (success) {
        closeModal('modal-ekstra');
      }
    });

    document.getElementById('form-penilaian').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btn = document.getElementById('btn-save-penilaian');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const id = document.getElementById('penilaian-id').value;
      let data;

      if (id) {
        // Mode Edit: ambil data dari record yang sedang diedit
        const existingRecord = allData.find(d => d.id === id && d.type === 'penilaian');
        data = {
          nama: existingRecord.nama,
          kelas: existingRecord.kelas,
          ekstra: existingRecord.ekstra,
          nilai: document.getElementById('penilaian-nilai').value,
          catatan: document.getElementById('penilaian-catatan').value
        };
      } else {
        // Mode Tambah: ambil dari form
        const selectedOption = document.getElementById('penilaian-nama').selectedOptions[0];
        data = {
          nama: document.getElementById('penilaian-nama').value,
          kelas: selectedOption.dataset.kelas,
          ekstra: selectedOption.dataset.ekstra,
          nilai: document.getElementById('penilaian-nilai').value,
          catatan: document.getElementById('penilaian-catatan').value
        };
      }

      let success;
      if (id) {
        success = await updateRecord('penilaian', id, data);
      } else {
        success = await createRecord('penilaian', data);
      }

      btn.disabled = false;
      btn.textContent = 'Simpan';

      if (success) {
        closeModal('modal-penilaian');
      }
    });

    document.getElementById('form-absensi').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btn = document.getElementById('btn-save-absensi');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const id = document.getElementById('absensi-id').value;
      let data;

      if (id) {
        // Mode Edit: ambil data dari record yang sedang diedit
        const existingRecord = allData.find(d => d.id === id && d.type === 'absensi');
        data = {
          tanggal: existingRecord.tanggal,
          nama: existingRecord.nama,
          kelas: existingRecord.kelas,
          ekstra: existingRecord.ekstra,
          status: document.getElementById('absensi-status').value
        };
      } else {
        // Mode Tambah: ambil dari form
        const selectedOption = document.getElementById('absensi-nama').selectedOptions[0];
        data = {
          tanggal: document.getElementById('absensi-tanggal').value,
          nama: document.getElementById('absensi-nama').value,
          kelas: selectedOption.dataset.kelas,
          ekstra: selectedOption.dataset.ekstra,
          status: document.getElementById('absensi-status').value
        };
      }

      let success;
      if (id) {
        success = await updateRecord('absensi', id, data);
      } else {
        success = await createRecord('absensi', data);
      }

      btn.disabled = false;
      btn.textContent = 'Simpan';

      if (success) {
        closeModal('modal-absensi');
      }
    });

    document.getElementById('form-jurnal').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btn = document.getElementById('btn-save-jurnal');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const id = document.getElementById('jurnal-id').value;
      const data = {
        tanggal: document.getElementById('jurnal-tanggal').value,
        ekstra: document.getElementById('jurnal-ekstra').value,
        kegiatan: document.getElementById('jurnal-kegiatan').value,
        deskripsi: document.getElementById('jurnal-deskripsi').value
      };

      let success;
      if (id) {
        success = await updateRecord('jurnal', id, data);
      } else {
        success = await createRecord('jurnal', data);
      }

      btn.disabled = false;
      btn.textContent = 'Simpan';

      if (success) {
        closeModal('modal-jurnal');
      }
    });

    // === ELEMENT SDK CONFIG ===

    async function onConfigChange(config) {
      const appTitle = document.getElementById('appTitle');
      const schoolName = document.getElementById('schoolName');
      const sidebar = document.getElementById('sidebar');
      
      if (appTitle) {
        appTitle.textContent = config.app_title || defaultConfig.app_title;
      }
      if (schoolName) {
        schoolName.textContent = config.school_name || defaultConfig.school_name;
      }
      if (sidebar) {
        sidebar.style.background = config.surface_color || defaultConfig.surface_color;
      }
      
      document.body.style.background = config.background_color || defaultConfig.background_color;
      document.body.style.color = config.text_color || defaultConfig.text_color;
    }

    // === INITIALIZATION ===

    (async function init() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  config.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                set: (value) => {
                  config.primary_action_color = value;
                  window.elementSdk.setConfig({ primary_action_color: value });
                }
              },
              {
                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  config.secondary_action_color = value;
                  window.elementSdk.setConfig({ secondary_action_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["school_name", config.school_name || defaultConfig.school_name]
          ])
        });
      }
      
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('absensi-tanggal-klasikal').value = today;
      
      // Event listener untuk search anggota
      const searchAnggota = document.getElementById('search-anggota');
      if (searchAnggota) {
        searchAnggota.addEventListener('input', function() {
          renderAnggotaTable();
        });
      }
      
      // Load data from Google Sheets
      await fetchAllData();
    })();
  </script>
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a8f8dca80d2fe14',t:'MTc2NDg5NTg3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
 </body>

</html>
